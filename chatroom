#!/bin/env bash


port=51423
cast=255.255.255.255
user=$USER

clear &&
echo "Welcome to Blackcat Chatroom"
echo "Chat started as $user. Type message and press Enter."

listen_chat() {
    socat -u UDP4-RECVFROM:$port,broadcast,fork - | while read -r line; do
        # Assume input format "user> message"
        if [[ $line == *">"* ]]; then
            sender=$(echo "$line" | cut -d'>' -f1)
            msg=$(echo "$line" | cut -d'>' -f2-)
            if [ "$sender" != "$user" ]; then
                echo -e "\r[$sender]--> $msg"
                if [[ $(echo -e "$msg" || grep "youtube.com") == true ]];then
                    mpv $(echo -e "$msg")
                fi
                notify-send "$sender" "$msg" &&
                echo -n "[$user]--| "
            fi
        fi
    done
}

listen_chat & pidnum=$!

echo -n "[$user]--| "
while read -r msg; do
    echo "$user>$msg" | socat - UDP4-DATAGRAM:$cast:$port,broadcast
    echo -n "[$user]--| "
done

kill $pidnum
